{# Template: index.html
    Purpose: Recipe list view with folder breadcrumb, filter by folder, and search integration.
    Notes:
    - Click on a recipe row opens detail unless a link/button was clicked.
    - Admins/owners see edit/delete; everyone can fetch PDF.
#}
{% extends "base.html" %}

{% block title %}{{ _("Rezepte") }}{% endblock %}
{% macro render_folder_options(folders, level=0, current_id=None) %}
    {% for f in folders %}
        <option value="{{ f.id }}" {% if current_id == f.id %}selected{% endif %}>
            {{ ("&nbsp;&nbsp;&nbsp;&nbsp;" * level) | safe }}üìÅ {{ f.name }}
        </option>
        {% if f.children %}
            {{ render_folder_options(f.children, level + 1, current_id) }}
        {% endif %}
    {% endfor %}
{% endmacro %}

{% block content %}
<div class="py-6">
    {# ================================= #}
    {# PAGE HEADER WITH NAVIGATION       #}
    {# ================================= #}
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-8 bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
        
        <div class="flex-1">
            <nav class="flex items-center gap-2 text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">
                {% for crumb in breadcrumbs %}
                    <a href="{{ url_for('index') }}?folder={{ crumb.id }}" class="hover:text-accent">{{ crumb.name }}</a>
                    {% if not loop.last %}
                        <span class="text-slate-400 font-normal">&#x276F;</span>
                    {% endif %}
                {% endfor %}
            </nav>
            <h1 class="text-2xl font-bold text-slate-800">
                {% if request.query_params.q %}{{ _("Suche:") }} "{{ request.query_params.q }}"
                {% else %}
                {% if breadcrumbs %}{{ breadcrumbs[-1].name }}{% else %}{{ _("Alle Rezepte") }}{% endif %}
                {% endif %}
            </h1>
            <span class="text-xs font-bold text-slate-400 uppercase tracking-widest mt-1 inline-block">
                {{ recipes|length }} {{ _("Eintr√§ge") }}
            </span>
        </div>

        <div class="w-full md:w-64">
            <form action="{{ url_for('index') }}" method="get" id="folder-filter-form" class="w-full">
                <select name="folder" 
                        onchange="this.form.submit()"
                        class="w-full rounded-lg border-slate-200 text-sm focus:border-accent focus:ring-accent">
                    {{ render_folder_options(folder_tree, 0, current_folder) }}
                </select>
                {% if request.query_params.q %}
                    <input type="hidden" name="q" value="{{ request.query_params.q }}">
                {% endif %}
            </form>
        </div>
    </div>

    {# ================================= #}
    {# ERROR MESSAGE (if search failed)  #}
    {# ================================= #}
    {% if search_error %}
    <div class="mb-6 p-4 bg-red-50 border border-red-200 rounded-lg text-red-800 text-sm">
        <div class="flex items-start gap-3">
            <span class="text-xl mt-0.5">‚ö†Ô∏è</span>
            <div>
                <p class="font-semibold mb-1">{{ _("Suchanfrage fehlerhaft") }}</p>
                <p>{{ search_error }}</p>
                <p class="mt-2 text-xs text-red-700">
                    <strong>{{ _("Tipp:") }}</strong> {{ _("Verwende z.B.") }} <code class="bg-red-100 px-1 rounded">zutat: krisch</code>, 
                    <code class="bg-red-100 px-1 rounded">rezeptname: pasta</code>, {{ _("oder") }} 
                    <code class="bg-red-100 px-1 rounded">autor: meier</code>
                </p>
            </div>
        </div>
    </div>
    {% endif %}

    {# ================================= #}
    {# RECIPE LIST                       #}
    {# ================================= #}
    <div class="space-y-2">
        {% for recipe in recipes %}
        <article class="group bg-white rounded-xl border border-slate-200 hover:border-accent/30 hover:shadow-md transition-all">
            <div class="flex items-center justify-between py-2 px-3 cursor-pointer sm:cursor-default" 
                 onclick="toggleMobileMenu('{{ recipe.id }}')">
                
                {# Recipe Info #}
                <div class="row-recipe flex items-center gap-4 flex-1 min-w-0 cursor-pointer" data-recipe-id="{{ recipe.id }}" data-href="{{ url_for('read_recipe', recipe_id=recipe.id) }}">
                    <div class="min-w-0">
                        <h2 class="text-lg font-semibold text-slate-800 truncate leading-tight group-hover:text-accent transition-colors">
                            <a href="{{ url_for('read_recipe', recipe_id=recipe.id) }}" class="no-underline">{{ recipe.name }}</a>
                        </h2>
                        <p class="text-xs text-slate-400 truncate">
                            {{ _("von") }} {{ recipe.author }}
                        </p>
                    </div>
                </div>

                {# Action Buttons (Desktop only) #}
                <div class="hidden sm:flex rounded-lg overflow-hidden border border-slate-400">
                    {% if is_admin or (current_user_id == recipe.owner_id) %}
                    <a href="{{ url_for('edit_recipe', recipe_id=recipe.id) }}" class="px-2 py-1 border-r border-slate-400 color-nav-bg color-nav-text hover:bg-accent-soft hover:text-accent no-underline transition-colors"><span class="ph-btn-icon text-lg mr-1">&#xE3B4;</span><span class="hidden lg:inline"> {{ _("Bearbeiten") }}</span></a>
                    {% endif %}
                    {% if is_admin %}
                    <button onclick="removeRecipe(this)" data-delete-url="{{ url_for('delete_recipe', recipe_id=recipe.id) }}" class="px-2 py-1 border-r border-slate-400 color-nav-bg color-nav-text text-danger bg-danger-soft hover:bg-danger hover:text-white no-underline transition-colors"><span class="ph-btn-icon text-lg mr-1">&#xE4A6;</span><span class="hidden lg:inline"> {{ _("L√∂schen") }}</span></button>
                    {% endif %}
                    <a href="{{ url_for('get_pdf', recipe_id=recipe.id) }}" target="_blank" class="px-2 py-1 color-nav-bg color-nav-text hover:bg-accent-soft hover:text-accent no-underline transition-colors"><span class="ph-btn-icon text-lg mr-1">&#xE702;</span><span class="hidden lg:inline"> PDF</span></a>
                </div>
            </div>
        </article>
        {% endfor %}
    </div>
</div>

{# ================================= #}
{# JAVASCRIPT                        #}
{# ================================= #}
<script>
// Delete recipe with confirmation
function removeRecipe(btn) {
    const deleteUrl = btn.getAttribute('data-delete-url');

    if (confirm('{{ _("Rezept wirklich unwiderruflich l√∂schen?") }}')) {
        window.location.href = deleteUrl;
    }
}   

// Toggle mobile menu (optional accordion behavior)
function toggleMobileMenu(id) {
    if (window.innerWidth >= 768) return;
    
    const extra = document.getElementById('extra-' + id);
    const arrow = document.getElementById('arrow-' + id);
    
    // Close all other menus
    document.querySelectorAll('[id^="extra-"]').forEach(el => {
        if (el.id !== 'extra-' + id) el.classList.add('hidden');
    });
    
    // Toggle current menu
    const isHidden = extra.classList.contains('hidden');
    extra.classList.toggle('hidden');
    arrow.style.transform = isHidden ? 'rotate(90deg)' : 'rotate(0deg)';
}

// Click on recipe row to open detail (ignores button/link clicks)
document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.row-recipe').forEach(row => {
        const target = row.dataset.href;
        if (!target) return;
        row.addEventListener('click', (e) => {
            if (e.target.closest('a, button')) return; // do not hijack link/button clicks
            window.location.href = target;
        });
    });
});
</script>
{% endblock %}