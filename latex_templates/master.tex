% FIX: 'footsepline' enforces the footer line globally and reliably
\documentclass[a4paper,12pt,footsepline]{scrartcl}

% -- LuaLaTeX Setup --
\usepackage{fontspec}
\usepackage[ngerman]{babel}
\usepackage[style=swiss]{csquotes} 

% -- Font Setup (Source Sans 3) --
% Using \setmainfont changes the body text.
% Using \setsansfont ensures headers (like "Zubereitung") match.
\setmainfont{source-sans-3-latin-300-normal.ttf}[
    Path = << FONT_PATH >>,
    BoldFont = source-sans-3-latin-400-normal.ttf,
    ItalicFont = source-sans-3-latin-300-italic.ttf,
    BoldItalicFont = source-sans-3-latin-400-italic.ttf
]

% Add this to fix \textbf looking like Computer Modern
\setsansfont{source-sans-3-latin-300-normal.ttf}[
    Path = << FONT_PATH >>,
    BoldFont = source-sans-3-latin-400-normal.ttf,
    ItalicFont = source-sans-3-latin-300-italic.ttf,
    BoldItalicFont = source-sans-3-latin-400-italic.ttf
]

% Set the entire document to sans-serif to achieve the Frutiger aesthetic
\renewcommand{\familydefault}{\sfdefault}
% Ensure KOMA-Script headers also use the new font family
\addtokomafont{disposition}{\rmfamily}

% -- PHOSPHOR ICONS SETUP (The elegant way) --
% Load the font directly from the folder.
% "Ligatures=TeX" ensures that words like "Warning" become icons.
\newfontfamily\iconFont[
    Path = << FONT_PATH >>,
    Extension = .ttf,
    Renderer = HarfBuzz,
    UprightFont = Phosphor,
    Ligatures=TeX
]{Phosphor}

% -- Layout --
\usepackage[left=2.5cm, right=2.5cm, top=2cm, bottom=2cm, includehead, includefoot]{geometry}
\usepackage{tabularx}
\usepackage{booktabs}
\usepackage{parskip} 
\usepackage{array} 
\usepackage{xcolor}

% -- Footer Setup --
\usepackage{scrlayer-scrpage}
\usepackage{ccicons}

\pagestyle{scrheadings}
\clearpairofpagestyles 

\ifoot[\footnotesize Generiert: << date_print >>]{\footnotesize Generiert: << date_print >>}
\cfoot[\ccbyncsa]{\ccbyncsa}
\ofoot[\footnotesize Stand: << date_version >>]{\footnotesize Letzte Ã„nderung: << date_version >>}

% -- Science & Units --
\usepackage[version=4]{mhchem}
\usepackage{siunitx}
\sisetup{
  locale = DE, 
  detect-all,
  range-phrase = --,
  range-units = single,
  per-mode = symbol
}

% -- Custom Units from Database --
<< unit_defs >>

% -- Metadata --
\title{ << recipe.name >> }
\author{ << recipe.author >> }
\date{}

\begin{document}

% -- Header --
\section*{<< recipe.name >>}

\noindent
Von << recipe.author >>
<% if source -%>
    \hfill {\small \textit{Quelle: << source >>}}
<% endif -%>

% -- Preamble --
<% if preamble -%>
    \vspace{0.5em}

    \noindent
    << preamble >>
<% endif -%>

\vspace{1em}

% -- Content Table --
\noindent
\begin{tabularx}{\textwidth}{@{} >{\raggedright\arraybackslash}p{4cm} X @{}}
    %\toprule
    \textbf{Zutaten} & \textbf{Zubereitung} \\
    \midrule
    <% for step in steps -%>
        
        <% if step.is_ingredients == 1 -%>
            % -- CASE A: Normal ingredient list --
            <% if step.ingredients -%>
                <% for ing in step.ingredients -%>
                    <% if ing.amount_max -%>
                        \qtyrange{<< ing.amount_min >>}{<< ing.amount_max >>}{<< ing.unit_cmd >>}
                    <% else -%>
                        \qty{<< ing.amount_min >>}{<< ing.unit_cmd >>}
                    <% endif -%>
                     ~<< ing.item >>
                    <% if ing.note -%> \textit{\small{(<< ing.note >>)}}<% endif -%>
                    <% if not loop.last -%>\newline<% endif -%> 
                <% endfor -%>
            <% endif -%>
        
        <% else -%>
            \hfill \raisebox{-4pt}{\iconFont\large{\symbol{<< step.latex_icon >>}}}
        <% endif -%>

        &
        << step.latex_text >> \\
        <% if not loop.last -%>\addlinespace[1em]<% endif -%>
    <% endfor -%>
    %\bottomrule
\end{tabularx}

\end{document}